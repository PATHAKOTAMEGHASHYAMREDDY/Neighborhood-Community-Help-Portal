<div class="admin-container">
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
      <button class="toggle-btn" (click)="toggleSidebar()" type="button">
        <mat-icon>menu</mat-icon>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a routerLink="/admin" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="nav-icon"><mat-icon>dashboard</mat-icon></span>
        <span class="nav-text">Dashboard</span>
      </a>

      <a routerLink="/admin/users" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>group</mat-icon></span>
        <span class="nav-text">Users</span>
      </a>

      <a routerLink="/admin/requests" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>assignment</mat-icon></span>
        <span class="nav-text">Requests</span>
      </a>

      <a routerLink="/admin/reports" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>report_problem</mat-icon></span>
        <span class="nav-text">Reports</span>
      </a>

      <a routerLink="/admin/analytics" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>analytics</mat-icon></span>
        <span class="nav-text">Analytics</span>
      </a>

      <a (click)="logout()" class="nav-item logout">
        <span class="nav-icon"><mat-icon>logout</mat-icon></span>
        <span class="nav-text">Logout</span>
      </a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="dashboard-header">
      <div class="header-content">
        <div>
          <h1>Admin Dashboard</h1>
          <p>System overview and analytics</p>
        </div>
        <div class="admin-badge">
          <mat-icon>security</mat-icon>
          <span class="badge-text">Administrator</span>
        </div>
      </div>
    </header>

    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <p>Loading dashboard data...</p>
    </div>

    <div class="dashboard-content" *ngIf="!isLoading">
      <section class="analytics-cards">
        <div class="stat-card total-users">
          <div class="card-icon"><mat-icon>people</mat-icon></div>
          <div class="card-content">
            <h3>Total Users</h3>
            <p class="card-number">{{ totalUsers }}</p>
            <span class="card-label">Platform members</span>
          </div>
        </div>

        <div class="stat-card residents">
          <div class="card-icon"><mat-icon>home</mat-icon></div>
          <div class="card-content">
            <h3>Residents</h3>
            <p class="card-number">{{ totalResidents }}</p>
            <span class="card-label">Active residents</span>
          </div>
        </div>

        <div class="stat-card helpers">
          <div class="card-icon"><mat-icon>handshake</mat-icon></div>
          <div class="card-content">
            <h3>Helpers</h3>
            <p class="card-number">{{ totalHelpers }}</p>
            <span class="card-label">Community helpers</span>
          </div>
        </div>

        <div class="stat-card total-requests">
          <div class="card-icon"><mat-icon>assignment</mat-icon></div>
          <div class="card-content">
            <h3>Total Requests</h3>
            <p class="card-number">{{ totalRequests }}</p>
            <span class="card-label">All time</span>
          </div>
        </div>

        <div class="stat-card completed">
          <div class="card-icon"><mat-icon>check_circle</mat-icon></div>
          <div class="card-content">
            <h3>Completed</h3>
            <p class="card-number">{{ completedRequests }}</p>
            <span class="card-label">Successfully finished</span>
          </div>
        </div>

        <div class="stat-card pending">
          <div class="card-icon"><mat-icon>hourglass_empty</mat-icon></div>
          <div class="card-content">
            <h3>Pending</h3>
            <p class="card-number">{{ pendingRequests }}</p>
            <span class="card-label">Awaiting helpers</span>
          </div>
        </div>
      </section>

      <section class="status-distribution">
        <h2>Request Status Distribution</h2>
        <div class="status-grid">
          <div class="status-item status-pending">
            <div class="status-bar">
              <div class="status-fill" [style.width.%]="(pendingRequests / totalRequests) * 100"></div>
            </div>
            <div class="status-info">
              <span class="status-label">Pending</span>
              <span class="status-count">{{ pendingRequests }}</span>
            </div>
          </div>

          <div class="status-item status-accepted">
            <div class="status-bar">
              <div class="status-fill" [style.width.%]="(acceptedRequests / totalRequests) * 100"></div>
            </div>
            <div class="status-info">
              <span class="status-label">Accepted</span>
              <span class="status-count">{{ acceptedRequests }}</span>
            </div>
          </div>

          <div class="status-item status-in-progress">
            <div class="status-bar">
              <div class="status-fill" [style.width.%]="(inProgressRequests / totalRequests) * 100"></div>
            </div>
            <div class="status-info">
              <span class="status-label">In-Progress</span>
              <span class="status-count">{{ inProgressRequests }}</span>
            </div>
          </div>

          <div class="status-item status-completed">
            <div class="status-bar">
              <div class="status-fill" [style.width.%]="(completedRequests / totalRequests) * 100"></div>
            </div>
            <div class="status-info">
              <span class="status-label">Completed</span>
              <span class="status-count">{{ completedRequests }}</span>
            </div>
          </div>
        </div>
      </section>

      <section class="recent-requests">
        <div class="section-header">
          <h2>Recent Help Requests</h2>
          <a routerLink="/admin/requests" class="view-all-btn">View All →</a>
        </div>

        <div class="no-data" *ngIf="recentRequests.length === 0">
          <p>No requests found</p>
        </div>

        <div class="requests-table" *ngIf="recentRequests.length > 0">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Category</th>
                <th>Resident</th>
                <th>Helper</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of recentRequests">
                <td>#{{ request.id }}</td>
                <td class="title-cell">{{ request.title }}</td>
                <td><span class="category-badge">{{ request.category }}</span></td>
                <td>{{ request.resident_name || 'N/A' }}</td>
                <td>{{ request.helper_name || 'Unassigned' }}</td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(request.status)">
                    {{ request.status }}
                  </span>
                </td>
                <td>{{ request.created_at | date:'short' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="actions-grid">
          <a routerLink="/admin/users" class="action-card">
            <div class="action-icon"><mat-icon>group</mat-icon></div>
            <h3>Manage Users</h3>
            <p>View and manage all platform users</p>
          </a>

          <a routerLink="/admin/requests" class="action-card">
            <div class="action-icon"><mat-icon>assignment</mat-icon></div>
            <h3>View Requests</h3>
            <p>Monitor all help requests</p>
          </a>

          <a routerLink="/admin/analytics" class="action-card">
            <div class="action-icon"><mat-icon>analytics</mat-icon></div>
            <h3>Analytics</h3>
            <p>View detailed platform statistics</p>
          </a>

          <button (click)="openDownloadModal()" class="action-card action-btn" type="button">
            <span class="action-icon">⬇️</span>
            <span class="action-title">Download Reports</span>
            <span class="action-desc">Export daily or weekly reports as CSV</span>
          </button>

          <a routerLink="/profile" class="action-card">
            <div class="action-icon"><mat-icon>settings</mat-icon></div>
            <h3>Settings</h3>
            <p>Configure admin preferences</p>
          </a>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Download Reports Modal -->
<div class="modal-overlay" *ngIf="showDownloadModal" (click)="closeDownloadModal()">
  <div class="modal-content download-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><mat-icon>download</mat-icon> Download Reports</h2>
      <button class="close-btn" (click)="closeDownloadModal()" type="button">×</button>
    </div>

    <div class="modal-body">
      <p class="modal-subtitle">Select the type of data you want to export as CSV</p>

      <div class="download-options">
        <!-- Users Report -->
        <div class="download-card">
          <div class="download-icon users-icon">
            <mat-icon>people</mat-icon>
          </div>
          <div class="download-info">
            <h3>Users Report</h3>
            <p>Export all users data (Residents &amp; Helpers)</p>
          </div>
          <button (click)="downloadUsersReport()" class="download-btn" type="button" [disabled]="isDownloading">
            <mat-icon>download</mat-icon>
            <span *ngIf="!isDownloading">Download</span>
            <span *ngIf="isDownloading && downloadingType === 'users'">Downloading...</span>
            <span *ngIf="isDownloading && downloadingType !== 'users'">Download</span>
          </button>
        </div>

        <!-- Requests Report -->
        <div class="download-card">
          <div class="download-icon requests-icon">
            <mat-icon>assignment</mat-icon>
          </div>
          <div class="download-info">
            <h3>Requests Report</h3>
            <p>Export all help requests with status</p>
            <div class="time-filter">
              <label class="filter-option">
                <input type="radio" name="requestsTime" value="all" [(ngModel)]="requestsTimeFilter">
                <span>All Time</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="requestsTime" value="daily" [(ngModel)]="requestsTimeFilter">
                <span>Today</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="requestsTime" value="weekly" [(ngModel)]="requestsTimeFilter">
                <span>This Week</span>
              </label>
            </div>
          </div>
          <button (click)="downloadRequestsReport()" class="download-btn" type="button" [disabled]="isDownloading">
            <mat-icon>download</mat-icon>
            <span *ngIf="!isDownloading">Download</span>
            <span *ngIf="isDownloading && downloadingType === 'requests'">Downloading...</span>
            <span *ngIf="isDownloading && downloadingType !== 'requests'">Download</span>
          </button>
        </div>

        <!-- User Reports (Issues) -->
        <div class="download-card">
          <div class="download-icon reports-icon">
            <mat-icon>report_problem</mat-icon>
          </div>
          <div class="download-info">
            <h3>User Reports</h3>
            <p>Export all user-submitted issue reports</p>
            <div class="time-filter">
              <label class="filter-option">
                <input type="radio" name="reportsTime" value="all" [(ngModel)]="reportsTimeFilter">
                <span>All Time</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="reportsTime" value="daily" [(ngModel)]="reportsTimeFilter">
                <span>Today</span>
              </label>
              <label class="filter-option">
                <input type="radio" name="reportsTime" value="weekly" [(ngModel)]="reportsTimeFilter">
                <span>This Week</span>
              </label>
            </div>
          </div>
          <button (click)="downloadUserReports()" class="download-btn" type="button" [disabled]="isDownloading">
            <mat-icon>download</mat-icon>
            <span *ngIf="!isDownloading">Download</span>
            <span *ngIf="isDownloading && downloadingType === 'reports'">Downloading...</span>
            <span *ngIf="isDownloading && downloadingType !== 'reports'">Download</span>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="closeDownloadModal()" class="btn-secondary" type="button">Close</button>
    </div>
  </div>
</div>
