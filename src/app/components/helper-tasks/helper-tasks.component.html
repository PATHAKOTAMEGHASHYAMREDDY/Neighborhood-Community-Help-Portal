<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <h2>Community Help</h2>
      <button class="toggle-btn" (click)="toggleSidebar()" type="button">
        <mat-icon>menu</mat-icon>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a routerLink="/helper/requests" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>dashboard</mat-icon></span>
        <span class="nav-text">Dashboard</span>
      </a>
      <a routerLink="/helper/requests" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>assignment</mat-icon></span>
        <span class="nav-text">Available Requests</span>
      </a>
      <a routerLink="/helper/tasks" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item">
        <span class="nav-icon"><mat-icon>check_circle</mat-icon></span>
        <span class="nav-text">My Tasks</span>
      </a>
      <a routerLink="/profile" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>person</mat-icon></span>
        <span class="nav-text">Profile</span>
      </a>
      <a routerLink="/my-reports" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>description</mat-icon></span>
        <span class="nav-text">My Reports</span>
      </a>
      <a routerLink="/report-issue" routerLinkActive="active" class="nav-item">
        <span class="nav-icon"><mat-icon>warning</mat-icon></span>
        <span class="nav-text">Report Issue</span>
      </a>
      <a (click)="logout()" class="nav-item logout">
        <span class="nav-icon"><mat-icon>logout</mat-icon></span>
        <span class="nav-text">Logout</span>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Mobile Hamburger Button -->
    <button class="mobile-menu-btn" (click)="toggleSidebar()" type="button">
      <mat-icon>menu</mat-icon>
    </button>

    <header class="dashboard-header">
      <div class="header-content">
        <div>
          <h1>My Tasks</h1>
          <p>Manage your accepted help requests</p>
        </div>
      </div>
    </header>

    <div class="loading" *ngIf="isLoading">
      <p>Loading your tasks...</p>
    </div>

    <div class="error-message" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>

    <div class="success-message" *ngIf="successMessage">
      {{ successMessage }}
    </div>

    <div class="no-tasks" *ngIf="!isLoading && myTasks.length === 0">
      <div class="empty-state">
        <div class="empty-icon"><mat-icon>assignment</mat-icon></div>
        <h3>No Tasks Yet</h3>
        <p>You haven't accepted any help requests yet.</p>
        <a routerLink="/helper/requests" class="browse-btn">Browse Available Requests</a>
      </div>
    </div>

    <section class="tasks-section" *ngIf="!isLoading && myTasks.length > 0">
      <div class="tasks-grid">
        <div class="task-card" *ngFor="let task of myTasks">
          <div class="task-header">
            <h3>{{ task.title }}</h3>
            <span class="status-badge" [ngClass]="getStatusClass(task.status)">
              {{ task.status }}
            </span>
          </div>

          <div class="task-body">
            <p class="task-description">{{ task.description }}</p>

            <div class="task-meta">
              <div class="meta-item">
                <span class="meta-icon"><mat-icon>folder</mat-icon></span>
                <span class="meta-text">{{ task.category }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon"><mat-icon>person</mat-icon></span>
                <span class="meta-text">{{ task.resident_name }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon"><mat-icon>place</mat-icon></span>
                <span class="meta-text">{{ task.resident_location || 'Location not specified' }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-icon"><mat-icon>event</mat-icon></span>
                <span class="meta-text">{{ task.created_at | date:'short' }}</span>
              </div>
            </div>

            <div class="status-timeline">
              <div class="timeline-item" [class.completed]="task.status === 'Accepted' || task.status === 'In-progress' || task.status === 'Completed'">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <h4>Accepted</h4>
                  <p>Task accepted by you</p>
                </div>
              </div>
              <div class="timeline-item" [class.completed]="task.status === 'In-progress' || task.status === 'Completed'">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <h4>In Progress</h4>
                  <p>Working on the task</p>
                </div>
              </div>
              <div class="timeline-item" [class.completed]="task.status === 'Completed'">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <h4>Completed</h4>
                  <p>Task finished</p>
                </div>
              </div>
            </div>
          </div>

          <div class="task-footer">
            <button
              *ngIf="task.status !== 'Pending'"
              class="action-btn chat-btn"
              (click)="openChat(task.id)"
              type="button">
              <mat-icon>chat</mat-icon>
              Chat
            </button>

            <button
              *ngIf="task.status === 'Accepted' || task.status === 'In-progress'"
              class="action-btn decline-btn"
              (click)="declineRequest(task.id)"
              [disabled]="updatingId === task.id"
              type="button">
              <mat-icon>cancel</mat-icon>
              {{ updatingId === task.id ? 'Declining...' : 'Decline Task' }}
            </button>

            <button
              *ngIf="canStartProgress(task.status)"
              class="action-btn start-btn"
              (click)="updateStatus(task.id, 'In-progress')"
              [disabled]="updatingId === task.id"
              type="button">
              {{ updatingId === task.id ? 'Updating...' : 'Start Progress' }}
            </button>

            <button
              *ngIf="canComplete(task.status)"
              class="action-btn complete-btn"
              (click)="updateStatus(task.id, 'Completed')"
              [disabled]="updatingId === task.id"
              type="button">
              {{ updatingId === task.id ? 'Updating...' : 'Mark as Completed' }}
            </button>

            <span *ngIf="task.status === 'Completed'" class="completed-badge">
              <mat-icon>check_circle</mat-icon>
              Task Completed
            </span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="dialog-overlay" *ngIf="showLogoutDialog" (click)="cancelLogout()">
    <div class="dialog-box" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>Confirm Logout</h3>
      </div>
      <div class="dialog-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="dialog-footer">
        <button class="btn-cancel" (click)="cancelLogout()" type="button">Cancel</button>
        <button class="btn-confirm" (click)="confirmLogout()" type="button">Logout</button>
      </div>
    </div>
  </div>
</div>

<app-notification-modal></app-notification-modal>
