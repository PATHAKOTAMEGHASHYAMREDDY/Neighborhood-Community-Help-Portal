<div class="dashboard-container">
  <!-- Mobile Hamburger Menu -->
  <button class="mobile-hamburger" (click)="toggleSidebar()" type="button">
    <mat-icon>menu</mat-icon>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
    <div class="sidebar-header">
      <h2>Community Help</h2>
      <button class="toggle-btn" (click)="toggleSidebar()" type="button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <nav class="sidebar-nav">
      <a routerLink="/requests" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item" (click)="closeSidebarOnMobile()">
        <span class="nav-icon"><mat-icon>dashboard</mat-icon></span>
        <span class="nav-text">Dashboard</span>
      </a>

      <a routerLink="/requests" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-item" (click)="closeSidebarOnMobile()">
        <span class="nav-icon"><mat-icon>assignment</mat-icon></span>
        <span class="nav-text">My Requests</span>
      </a>

      <a routerLink="/requests/new" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <span class="nav-icon"><mat-icon>add</mat-icon></span>
        <span class="nav-text">New Request</span>
      </a>

      <a routerLink="/profile" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <span class="nav-icon"><mat-icon>person</mat-icon></span>
        <span class="nav-text">Profile</span>
      </a>

      <a routerLink="/my-reports" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <span class="nav-icon"><mat-icon>description</mat-icon></span>
        <span class="nav-text">My Reports</span>
      </a>

      <a routerLink="/report-issue" routerLinkActive="active" class="nav-item" (click)="closeSidebarOnMobile()">
        <span class="nav-icon"><mat-icon>warning</mat-icon></span>
        <span class="nav-text">Report Issue</span>
      </a>

      <a (click)="logout()" class="nav-item logout">
        <span class="nav-icon"><mat-icon>logout</mat-icon></span>
        <span class="nav-text">Logout</span>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="dashboard-header">
      <div class="header-content">
        <div>
          <h1>Resident Dashboard</h1>
          <p>Track and manage your help requests</p>
        </div>
        <button class="new-request-btn" (click)="navigateToNewRequest()" type="button">
          + New Help Request
        </button>
      </div>
    </header>

    <!-- Summary Cards -->
    <section class="summary-cards">
      <div class="summary-card total">
        <div class="card-icon"><mat-icon>assignment</mat-icon></div>
        <div class="card-content">
          <h3>Total Requests</h3>
          <p class="card-number">{{ totalRequests }}</p>
        </div>
      </div>

      <div class="summary-card pending">
        <div class="card-icon"><mat-icon>hourglass_empty</mat-icon></div>
        <div class="card-content">
          <h3>Pending</h3>
          <p class="card-number">{{ pendingCount }}</p>
        </div>
      </div>

      <div class="summary-card progress">
        <div class="card-icon"><mat-icon>sync</mat-icon></div>
        <div class="card-content">
          <h3>In-Progress</h3>
          <p class="card-number">{{ inProgressCount }}</p>
        </div>
      </div>

      <div class="summary-card completed">
        <div class="card-icon"><mat-icon>check_circle</mat-icon></div>
        <div class="card-content">
          <h3>Completed</h3>
          <p class="card-number">{{ completedCount }}</p>
        </div>
      </div>
    </section>

    <!-- Requests List -->
    <section class="requests-section">
      <div class="section-header">
        <h2>My Help Requests</h2>
        <div class="filter-controls">
          <label class="checkbox-container">
            <input
              type="checkbox"
              [(ngModel)]="showCompleted"
              (change)="toggleCompletedFilter()"
            >
            <span class="checkmark"></span>
            <span class="checkbox-label">
              <mat-icon>check_circle</mat-icon>
              Show Only Completed Requests
              <span class="filter-count completed" *ngIf="showCompleted">
                ({{ filteredRequests.length }} completed)
              </span>
              <span class="filter-count pending" *ngIf="!showCompleted">
                ({{ filteredRequests.length }} active)
              </span>
            </span>
          </label>
        </div>
      </div>

      <div class="loading" *ngIf="isLoading">
        <p>Loading requests...</p>
      </div>

      <div class="error-message" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <div class="no-requests" *ngIf="!isLoading && filteredRequests.length === 0 && requests.length === 0">
        <p>You haven't created any requests yet.</p>
        <button class="new-request-btn" (click)="navigateToNewRequest()" type="button">
          Create Your First Request
        </button>
      </div>

      <div class="no-requests" *ngIf="!isLoading && filteredRequests.length === 0 && requests.length > 0">
        <mat-icon class="filter-icon">filter_list_off</mat-icon>
        <p>No requests to display with current filter</p>
        <p class="sub-text">All your requests are completed. Check the "Show Completed Requests" box to view them.</p>
      </div>

      <div class="requests-grid" *ngIf="!isLoading && filteredRequests.length > 0">
        <div class="request-card" *ngFor="let request of filteredRequests">
          <div class="request-header">
            <h3>{{ request.title }}</h3>
            <span class="status-badge" [class]="'status-' + request.status?.toLowerCase()">
              {{ request.status }}
            </span>
          </div>

          <div class="request-body">
            <p class="request-description">{{ request.description }}</p>
            <div class="request-meta">
              <span class="category">
                <strong>Category:</strong> {{ request.category }}
              </span>
              <span class="date">
                <strong>Created:</strong> {{ request.created_at | date:'short' }}
              </span>
            </div>

            <!-- Progress Timeline -->
            <div class="progress-timeline">
              <h4 class="timeline-title">Progress Timeline</h4>

              <div class="timeline-container">
                <div class="timeline-item" [class.active]="isStepCompleted(request.status, 'Pending')">
                  <div class="timeline-marker">
                    <div class="marker-circle">1</div>
                  </div>
                  <div class="timeline-content">
                    <h5>Request Submitted</h5>
                    <p>Your request has been posted and is waiting for a helper</p>
                    <span class="timeline-badge status-pending">Pending</span>
                  </div>
                </div>

                <div class="timeline-item" [class.active]="isStepCompleted(request.status, 'Accepted')">
                  <div class="timeline-marker">
                    <div class="marker-circle">2</div>
                  </div>
                  <div class="timeline-content">
                    <h5>Request Accepted</h5>
                    <p>A helper has accepted your request</p>
                    <span class="timeline-badge status-accepted">Accepted</span>
                  </div>
                </div>

                <div class="timeline-item" [class.active]="isStepCompleted(request.status, 'In-progress')">
                  <div class="timeline-marker">
                    <div class="marker-circle">3</div>
                  </div>
                  <div class="timeline-content">
                    <h5>In Progress</h5>
                    <p>The helper is working on your request</p>
                    <span class="timeline-badge status-in-progress">In-Progress</span>
                  </div>
                </div>

                <div class="timeline-item" [class.active]="isStepCompleted(request.status, 'Completed')">
                  <div class="timeline-marker">
                    <div class="marker-circle">4</div>
                  </div>
                  <div class="timeline-content">
                    <h5>Completed</h5>
                    <p>Your request has been successfully completed</p>
                    <span class="timeline-badge status-completed">Completed</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="request-footer">
            <button 
              class="chat-btn" 
              (click)="openChat(request.id)" 
              type="button"
              *ngIf="request.status !== 'Pending'"
              [disabled]="!request.helper_id">
              <mat-icon>chat</mat-icon>
              Chat
            </button>
            <button class="view-status-btn" (click)="viewRequestStatus(request.id)" type="button">
              <mat-icon>visibility</mat-icon>
              View Status
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Logout Confirmation Dialog -->
  <div class="dialog-overlay" *ngIf="showLogoutDialog" (click)="cancelLogout()">
    <div class="dialog-box" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>Confirm Logout</h3>
      </div>
      <div class="dialog-body">
        <p>Are you sure you want to logout?</p>
      </div>
      <div class="dialog-footer">
        <button class="btn-cancel" (click)="cancelLogout()" type="button">Cancel</button>
        <button class="btn-confirm" (click)="confirmLogout()" type="button">Logout</button>
      </div>
    </div>
  </div>
</div>
